name: Provision GameLand Infrastructure

on:
  workflow_dispatch:
    inputs:
      KUBERNETES_TYPE:
        description: "Kubernetes type"
        required: true
        type: choice
        options:
          - k3s
          - k8s
          - eks
          - ecs

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip openssh-client

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GAMELAND_SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa_gameland.pub
          chmod 600 ~/.ssh/id_rsa_gameland.pub
          echo "${{ secrets.GAMELAND_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa_gameland
          chmod 600 ~/.ssh/id_rsa_gameland

      - name: Setup AWS config and credentials files
        run: |
          mkdir -p ~/.aws
          printf "[profile terraform]\nregion = %s\noutput = json\n" "${{ env.AWS_REGION }}" > ~/.aws/config
          printf "[terraform]\naws_access_key_id = %s\naws_secret_access_key = %s\n" \
            "${{ secrets.AWS_ACCESS_KEY_ID }}" "${{ secrets.AWS_SECRET_ACCESS_KEY }}" > ~/.aws/credentials
          
      - name: Terraform Init / Apply
        run: |
          cd infrastructure/terraform/environments/${{ inputs.KUBERNETES_TYPE }}/
          terraform fmt
          terraform init
          terraform apply -auto-approve
          terraform refresh

      - name: Generate SSH config & Ansible inventory
        run: |
          cd infrastructure/terraform/environments/${{ inputs.KUBERNETES_TYPE }}/

          BASTION_IP=$(terraform output -json bastion_public_ips | jq -r '.[0]')

          cat <<EOF > ~/.ssh/config
          Host bastion_host
            HostName $BASTION_IP
            User admin
            IdentityFile ~/.ssh/id_rsa_gameland
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

          CONTROL_PLANE_IPS=($(terraform output -json cp_private_ips | jq -r '.[]'))
          WORKERS_APP_IPS=($(terraform output -json workers_app_private_ips | jq -r '.[]'))
          WORKERS_DB_IPS=($(terraform output -json workers_db_private_ips | jq -r '.[]'))

          OUTPUT_FILE="../../../ansible/inventories/k8s/hosts.yaml"

          cat > "$OUTPUT_FILE" <<EOF
          all:
            children:
              bastion:
                hosts:
                  bastion_host:
                    ansible_host: ${BASTION_IP}
              ${KUBERNETES_TYPE}:
                children:
                  control_plane:
                    hosts:
          EOF

          i=1
          for ip in "${CONTROL_PLANE_IPS[@]}"; do
            echo "            cp-$i:" >> "$OUTPUT_FILE"
            echo "              ansible_host: $ip" >> "$OUTPUT_FILE"
            ((i++))
          done

          echo "        workers_app:" >> "$OUTPUT_FILE"
          echo "          hosts:" >> "$OUTPUT_FILE"
          i=1
          for ip in "${WORKERS_APP_IPS[@]}"; do
            echo "            app-$i:" >> "$OUTPUT_FILE"
            echo "              ansible_host: $ip" >> "$OUTPUT_FILE"
            ((i++))
          done

          echo "        workers_db:" >> "$OUTPUT_FILE"
          echo "          hosts:" >> "$OUTPUT_FILE"
          i=1
          for ip in "${WORKERS_DB_IPS[@]}"; do
            echo "            db-$i:" >> "$OUTPUT_FILE"
            echo "              ansible_host: $ip" >> "$OUTPUT_FILE"
            ((i++))
          done

      - name: Upload inventory as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ansible-inventory
          path: ansible/inventories/k8s/hosts.yaml
